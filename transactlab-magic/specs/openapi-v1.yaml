openapi: 3.0.3
info:
  title: TransactLab Magic SDK API v1
  description: |
    Core API subset for TransactLab Magic SDK.
    Covers sessions, subscriptions, and webhooks for merchant integration.
  version: 1.0.0
  contact:
    name: TransactLab Support
    url: https://transactlab.com/support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://transactlab-backend.onrender.com/api/v1
    description: Production API
  - url: https://sandbox.transactlab.com/api/v1
    description: Sandbox API

security:
  - ApiKeyAuth: []
  - SandboxSecret: []

paths:
  /sandbox/sessions:
    post:
      summary: Create checkout session
      description: |
        Creates a new checkout session for one-time payments.
        Returns session details including checkout URL for redirect.
      operationId: createSession
      tags:
        - Sessions
      security:
        - SandboxSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
            examples:
              basic:
                summary: Basic one-time payment
                value:
                  amount: 300000
                  currency: "NGN"
                  description: "Product Purchase"
                  customerEmail: "customer@example.com"
                  success_url: "https://merchant.com/success"
                  cancel_url: "https://merchant.com/cancel"
              with_metadata:
                summary: With custom metadata
                value:
                  amount: 500000
                  currency: "USD"
                  description: "Premium Service"
                  customerEmail: "user@example.com"
                  metadata:
                    product_id: "prod_123"
                    campaign: "summer_sale"
                  success_url: "https://merchant.com/success?session_id={SESSION_ID}"
                  cancel_url: "https://merchant.com/checkout"
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '400':
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sandbox/subscriptions:
    post:
      summary: Create subscription
      description: |
        Creates a new subscription for recurring payments.
        Requires an existing plan ID from the merchant's configured plans.
      operationId: createSubscription
      tags:
        - Subscriptions
      security:
        - SandboxSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSubscriptionRequest'
            examples:
              monthly:
                summary: Monthly subscription
                value:
                  planId: "plan_monthly_50k"
                  customerEmail: "subscriber@example.com"
                  metadata:
                    tier: "premium"
                    source: "website"
                  success_url: "https://merchant.com/subscription-success"
                  cancel_url: "https://merchant.com/subscription-cancel"
              with_trial:
                summary: With trial period
                value:
                  planId: "plan_yearly_500k"
                  customerEmail: "trial@example.com"
                  trialDays: 14
                  metadata:
                    trial_user: true
                    source: "promo"
      responses:
        '200':
          description: Subscription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionResponse'
        '400':
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Plan not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /checkout/process/{sessionId}:
    post:
      summary: Process payment (Server Bridge)
      description: |
        Server bridge endpoint for processing payments securely.
        Used by frontend checkout pages to complete transactions.
      operationId: processPayment
      tags:
        - Payments
      security:
        - SandboxSecret: []
      parameters:
        - name: sessionId
          in: path
          required: true
          description: Session ID to process
          schema:
            type: string
            pattern: '^sess_[a-zA-Z0-9_]+$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessPaymentRequest'
      responses:
        '200':
          description: Payment processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
        '202':
          description: Payment under review
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'
        '400':
          description: Bad request - validation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks:
    post:
      summary: Webhook endpoint
      description: |
        Receives webhook events from TransactLab.
        Events include session completion, subscription updates, and payment status changes.
      operationId: receiveWebhook
      tags:
        - Webhooks
      security:
        - WebhookSecret: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
            examples:
              session_completed:
                summary: Session completed
                value:
                  id: "evt_1234567890"
                  type: "session.completed"
                  created: 1640995200
                  data:
                    object:
                      id: "sess_abc123"
                      status: "completed"
                      amount: 300000
                      currency: "NGN"
                      customerEmail: "customer@example.com"
                      metadata:
                        product_id: "prod_123"
              subscription_created:
                summary: Subscription created
                value:
                  id: "evt_1234567891"
                  type: "subscription.created"
                  created: 1640995200
                  data:
                    object:
                      id: "sub_xyz789"
                      status: "active"
                      planId: "plan_monthly_50k"
                      customerEmail: "subscriber@example.com"
                      currentPeriodStart: 1640995200
                      currentPeriodEnd: 1643673600
      responses:
        '200':
          description: Webhook received successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Bad request - invalid webhook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized - invalid webhook secret
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: Authorization
      description: Bearer token for API authentication
    SandboxSecret:
      type: apiKey
      in: header
      name: x-sandbox-secret
      description: Sandbox secret for testing
    WebhookSecret:
      type: apiKey
      in: header
      name: x-webhook-secret
      description: Webhook secret for verification

  schemas:
    CreateSessionRequest:
      type: object
      required:
        - amount
        - currency
        - description
        - customerEmail
      properties:
        amount:
          type: integer
          description: Amount in major currency units (e.g., 300000 for 300,000 NGN)
          minimum: 1
          example: 300000
        currency:
          type: string
          description: Currency code (ISO 4217)
          pattern: '^[A-Z]{3}$'
          example: "NGN"
        description:
          type: string
          description: Human-readable description of the payment
          maxLength: 255
          example: "Product Purchase"
        customerEmail:
          type: string
          format: email
          description: Customer email address
          example: "customer@example.com"
        customerName:
          type: string
          description: Customer name (optional)
          maxLength: 100
          example: "John Doe"
        success_url:
          type: string
          format: uri
          description: URL to redirect after successful payment
          example: "https://merchant.com/success?session_id={SESSION_ID}"
        cancel_url:
          type: string
          format: uri
          description: URL to redirect if payment is cancelled
          example: "https://merchant.com/cancel"
        metadata:
          type: object
          description: Custom metadata attached to the session
          additionalProperties: true
          example:
            product_id: "prod_123"
            campaign: "summer_sale"

    CreateSubscriptionRequest:
      type: object
      required:
        - planId
        - customerEmail
      properties:
        planId:
          type: string
          description: Plan ID for the subscription
          pattern: '^plan_[a-zA-Z0-9_]+$'
          example: "plan_monthly_50k"
        customerEmail:
          type: string
          format: email
          description: Customer email address
          example: "subscriber@example.com"
        customerName:
          type: string
          description: Customer name (optional)
          maxLength: 100
          example: "Jane Smith"
        trialDays:
          type: integer
          description: Number of trial days (optional)
          minimum: 0
          maximum: 365
          example: 14
        success_url:
          type: string
          format: uri
          description: URL to redirect after successful subscription creation
          example: "https://merchant.com/subscription-success"
        cancel_url:
          type: string
          format: uri
          description: URL to redirect if subscription creation is cancelled
          example: "https://merchant.com/subscription-cancel"
        metadata:
          type: object
          description: Custom metadata attached to the subscription
          additionalProperties: true
          example:
            tier: "premium"
            source: "website"
        chargeNow:
          type: boolean
          description: Whether to charge immediately (default: true)
          default: true
          example: true

    ProcessPaymentRequest:
      type: object
      required:
        - paymentMethod
      properties:
        paymentMethod:
          type: object
          description: Payment method details
          properties:
            type:
              type: string
              enum: [card, bank_transfer, mobile_money]
              description: Payment method type
              example: "card"
            card:
              type: object
              description: Card details (if type is card)
              properties:
                number:
                  type: string
                  description: Card number
                  pattern: '^[0-9]{13,19}$'
                  example: "4532555555555555"
                expiryMonth:
                  type: integer
                  description: Expiry month (1-12)
                  minimum: 1
                  maximum: 12
                  example: 12
                expiryYear:
                  type: integer
                  description: Expiry year (4 digits)
                  minimum: 2024
                  example: 2025
                cvc:
                  type: string
                  description: CVC code
                  pattern: '^[0-9]{3,4}$'
                  example: "123"
                name:
                  type: string
                  description: Name on card
                  example: "John Doe"
        billingAddress:
          type: object
          description: Billing address (optional)
          properties:
            line1:
              type: string
              description: Address line 1
              example: "123 Main Street"
            line2:
              type: string
              description: Address line 2 (optional)
              example: "Apt 4B"
            city:
              type: string
              description: City
              example: "Lagos"
            state:
              type: string
              description: State/Region
              example: "Lagos"
            postalCode:
              type: string
              description: Postal code
              example: "100001"
            country:
              type: string
              description: Country code (ISO 3166-1 alpha-2)
              pattern: '^[A-Z]{2}$'
              example: "NG"

    SessionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            sessionId:
              type: string
              description: Unique session identifier
              pattern: '^sess_[a-zA-Z0-9_]+$'
              example: "sess_abc123def456"
            checkoutUrl:
              type: string
              format: uri
              description: URL to redirect customer for payment
              example: "https://checkout.transactlab.com/sess_abc123def456"
            amount:
              type: string
              description: Formatted amount string
              example: "NGN 300,000.00"
            currency:
              type: string
              description: Currency code
              example: "NGN"
            description:
              type: string
              description: Session description
              example: "Product Purchase"
            customerEmail:
              type: string
              format: email
              description: Customer email
              example: "customer@example.com"
            status:
              type: string
              enum: [pending, completed, cancelled, expired]
              description: Session status
              example: "pending"
            expiresAt:
              type: string
              format: date-time
              description: Session expiration time
              example: "2025-09-11T15:30:00.000Z"
            metadata:
              type: object
              description: Custom metadata
              additionalProperties: true

    SubscriptionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            subscriptionId:
              type: string
              description: Unique subscription identifier
              pattern: '^sub_[a-zA-Z0-9_]+$'
              example: "sub_xyz789abc123"
            checkoutUrl:
              type: string
              format: uri
              description: URL to redirect customer for subscription setup
              example: "https://checkout.transactlab.com/sub_xyz789abc123"
            planId:
              type: string
              description: Plan identifier
              example: "plan_monthly_50k"
            customerEmail:
              type: string
              format: email
              description: Customer email
              example: "subscriber@example.com"
            status:
              type: string
              enum: [active, cancelled, past_due, trialing]
              description: Subscription status
              example: "active"
            currentPeriodStart:
              type: string
              format: date-time
              description: Start of current billing period
              example: "2025-09-11T00:00:00.000Z"
            currentPeriodEnd:
              type: string
              format: date-time
              description: End of current billing period
              example: "2025-10-11T00:00:00.000Z"
            trialEnd:
              type: string
              format: date-time
              description: End of trial period (if applicable)
              example: "2025-09-25T00:00:00.000Z"
            metadata:
              type: object
              description: Custom metadata
              additionalProperties: true

    PaymentResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            status:
              type: string
              enum: [completed, pending, failed, review_required, blocked_by_fraud]
              description: Payment status
              example: "completed"
            transactionId:
              type: string
              description: Transaction identifier
              example: "txn_abc123def456"
            amount:
              type: string
              description: Formatted amount
              example: "NGN 300,000.00"
            completedAt:
              type: string
              format: date-time
              description: Completion timestamp
              example: "2025-09-11T15:30:00.000Z"
            risk:
              type: object
              description: Fraud risk assessment (if applicable)
              properties:
                score:
                  type: integer
                  description: Risk score (0-100)
                  minimum: 0
                  maximum: 100
                  example: 25
                level:
                  type: string
                  enum: [low, medium, high]
                  description: Risk level
                  example: "low"
                factors:
                  type: array
                  items:
                    type: string
                  description: Risk factors
                  example: ["Low transaction amount", "Known customer"]
                recommendations:
                  type: array
                  items:
                    type: string
                  description: Risk mitigation recommendations
                  example: ["Monitor transaction", "Consider additional verification"]

    WebhookEvent:
      type: object
      required:
        - id
        - type
        - created
        - data
      properties:
        id:
          type: string
          description: Unique event identifier
          pattern: '^evt_[a-zA-Z0-9_]+$'
          example: "evt_1234567890"
        type:
          type: string
          description: Event type
          enum:
            - session.completed
            - session.cancelled
            - session.expired
            - subscription.created
            - subscription.updated
            - subscription.cancelled
            - invoice.paid
            - invoice.payment_failed
            - payment.completed
            - payment.failed
            - fraud.review_required
            - fraud.blocked
          example: "session.completed"
        created:
          type: integer
          description: Unix timestamp of event creation
          example: 1640995200
        data:
          type: object
          description: Event data payload
          properties:
            object:
              type: object
              description: The object that triggered the event
              additionalProperties: true
        livemode:
          type: boolean
          description: Whether this is a live mode event
          example: false

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error type
          example: "validation_failed"
        message:
          type: string
          description: Human-readable error message
          example: "Validation failed"
        details:
          type: object
          description: Additional error details
          properties:
            fieldHints:
              type: array
              items:
                type: string
              description: Field-specific validation errors
              example: ["missing amount", "invalid email format"]
        code:
          type: string
          description: Error code for programmatic handling
          example: "MISSING_REQUIRED_FIELD"

tags:
  - name: Sessions
    description: Checkout session management
  - name: Subscriptions
    description: Recurring subscription management
  - name: Payments
    description: Payment processing
  - name: Webhooks
    description: Event notifications
